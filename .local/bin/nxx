#!/bin/bash

set -e

commandName=$(basename $0)
flake_uri=$HOME/.config/home-manager
username=$(whoami)
home_uri=$flake_uri\#homeConfigurations.$username

get-home-manager() {
  echo "$(nix path-info $home_uri.activationPackage)/home-path/bin/home-manager"
}

# get path to a package
path() {
  nix path-info $home_uri.pkgs.$1
}

build() {
  # --show-trace show stack trace
  # --no-link don't link the result to the directory
  # --print-build-logs print build logs
  nix build --show-trace --no-link --print-build-logs $home_uri.activationPackage
}

switch() {
  "$(get-home-manager)" switch
}

update() {
  nix flake update $flake_uri
}

case $1 in
build)
  build
  ;;
switch)
  switch
  ;;
update)
  update
  ;;
path)
  path $2
  ;;
*)
  echo "Usage: $commandName {update|build|switch|path}"
  exit 1
  ;;
esac
